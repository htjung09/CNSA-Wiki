@page "/wiki"
@using CNSAWiki.Data
@using CNSAWiki.Models
@inject HttpClient Http
@inject AuthService Auth
@inject NavigationManager Navigation

<h2 class="mb-3">📘 최근 변경 문서</h2>

<div class="mb-3 d-flex gap-2">
    @if (Auth.Authorized)
    {
        <button class="btn btn-primary" @onclick="CreateNew">+ 새 문서 작성</button>
    }
    else
    {
        <div class="alert alert-warning p-2" style="max-width:350px;">
            글을 작성하려면 <a href="/login">로그인</a> 하세요.
        </div>
    }

    <button class="btn btn-outline-secondary" @onclick="GoSearch">
        🔍 검색
    </button>
</div>


@if (pages == null)
{
    <p>Loading...</p>
}
else if (pages.Count == 0)
{
    <div class="alert alert-info">아직 작성된 문서가 없습니다.</div>
}
else
{
    <ul class="list-group" style="max-width:600px;">
        @foreach (var pg in pages)
        {
            <li class="list-group-item d-flex justify-content-between align-items-center">
                <div>
                    <a href="/wiki/details/@pg.PageId" class="fw-bold">@pg.Title</a>
                    <div class="text-muted" style="font-size: 0.85rem;">
                        작성자 ID: @pg.AuthorId
                    </div>
                </div>

                @if (pg.AuthorId == Auth.UserId || Auth.Username == "admin")
                {
                    <div>
                        <button class="btn btn-sm btn-outline-secondary me-1" @onclick="() => EditPage(pg.PageId)">수정</button>
                        <button class="btn btn-sm btn-outline-danger" @onclick="() => DeletePage(pg.PageId)">삭제</button>
                    </div>
                }
            </li>
        }
    </ul>
}

@code {
    private List<WikiPage>? pages;

    protected override async Task OnInitializedAsync()
    {
        await LoadPages();
    }

    private async Task LoadPages()
    {
        pages = await Http.GetFromJsonAsync<List<WikiPage>>("api/wiki");
    }

    private void CreateNew()
    {
        Navigation.NavigateTo("/wiki/edit/0");
    }

    private void EditPage(long id)
    {
        Navigation.NavigateTo($"/wiki/edit/{id}");
    }

    private async Task DeletePage(long id)
    {
        await Http.DeleteAsync($"api/wiki/{id}");
        await LoadPages();
    }

    private void GoSearch()
    {
        Navigation.NavigateTo("/wiki/search");
    }
}
