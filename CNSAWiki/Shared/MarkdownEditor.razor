@using Microsoft.AspNetCore.Components.Web

<div class="row">
    <!-- 좌측: Markdown 입력 -->
    <div class="col-md-6">
        <textarea class="form-control"
                  style="height:350px; white-space:pre-wrap; font-family: monospace;"
                  @oninput="OnValueChanged"
                  placeholder="문서 내용을 입력하세요...">
                  @Value
        </textarea>
    </div>

    <!-- 우측: 미리보기 -->
    <div class="col-md-6 border p-2"
         style="height:350px; overflow:auto; background-color:#f8f9fa;">
        @((MarkupString)MarkdownToHtml(Value))
    </div>
</div>

@code {
    [Parameter] public string Value { get; set; } = "";
    [Parameter] public EventCallback<string> ValueChanged { get; set; }

    private async Task OnValueChanged(ChangeEventArgs e)
    {
        Value = e.Value?.ToString() ?? "";
        await ValueChanged.InvokeAsync(Value);
    }

    private string MarkdownToHtml(string markdown)
    {
        if (string.IsNullOrEmpty(markdown))
            return "";

        string html = markdown
            .Replace("&", "&amp;")
            .Replace("<", "&lt;")
            .Replace(">", "&gt;");

        // 코드 블럭 ``` ``` (줄바꿈 포함)
        html = System.Text.RegularExpressions.Regex.Replace(
            html,
            @"```([\s\S]+?)```",
            "<pre style='background-color:#e9ecef;padding:5px;'>$1</pre>");

        // 헤더: # ~ ######
        for (int i = 6; i >= 1; i--)
        {
            string pattern = @"^" + new string('#', i) + @"\s+(.+)$";
            string replacement = $"<h{i}>$1</h{i}>";
            html = System.Text.RegularExpressions.Regex.Replace(
                html, pattern, replacement, System.Text.RegularExpressions.RegexOptions.Multiline);
        }

        // 굵게 **
        html = System.Text.RegularExpressions.Regex.Replace(
            html, @"\*\*(.+?)\*\*", "<b>$1</b>");

        // 기울임 *
        html = System.Text.RegularExpressions.Regex.Replace(
            html, @"\*(.+?)\*", "<i>$1</i>");

        // 취소선 ~~text~~
        html = System.Text.RegularExpressions.Regex.Replace(
            html, @"~~(.+?)~~", "<s>$1</s>");

        // 순서 없는 리스트
        html = System.Text.RegularExpressions.Regex.Replace(
            html, @"^\s*[-*]\s+(.+)$", "<li>$1</li>", System.Text.RegularExpressions.RegexOptions.Multiline);
        html = System.Text.RegularExpressions.Regex.Replace(html, @"(<li>.+</li>)", "<ul>$1</ul>", System.Text.RegularExpressions.RegexOptions.Singleline);
        
        // 하이퍼링크: [텍스트](링크)
        html = System.Text.RegularExpressions.Regex.Replace(
            html,
            @"\[(.+?)\]\((https?://.+?)\)",
            "<a href='$2' target='_blank'>$1</a>");

        // 줄바꿈
        html = html.Replace("\n", "<br>");

        return html;
    }
}
