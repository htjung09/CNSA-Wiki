@using Microsoft.AspNetCore.Components.Forms
@using System.Text.RegularExpressions;
@inject HttpClient Http
@inject IJSRuntime JS

<div class="row">
    <!-- 좌측: Markdown 입력 -->
    <div class="d-flex mb-2 gap-2">
        <label class="btn btn-secondary btn-sm mb-0" style="cursor:pointer;">
            이미지 업로드
            <InputFile style="display:none" OnChange="OnImageSelected" />
        </label>
    </div>
    <div class="col-md-6">
        <textarea class="form-control"
                  id="editor"
                  style="height:350px; white-space:pre-wrap; font-family: monospace;"
                  @oninput="OnValueChanged"
                  placeholder="문서 내용을 입력하세요...">@Value</textarea>
    </div>

    <!-- 우측: Markdown 미리보기 -->
    <div class="col-md-6 border p-2"
         style="height:350px; overflow:auto; background-color:#f8f9fa;">
        @((MarkupString)MarkdownToHtml(Value))
    </div>
</div>

@code {
    [Parameter] public string Value { get; set; } = "";
    [Parameter] public EventCallback<string> ValueChanged { get; set; }

    /* =============== 입력 이벤트 =============== */
    private async Task OnValueChanged(ChangeEventArgs e)
    {
        Value = e.Value?.ToString() ?? "";
        await ValueChanged.InvokeAsync(Value);
    }

    /* =============== 이미지 선택 후 업로드 =============== */
    private async Task OnImageSelected(InputFileChangeEventArgs e)
    {
        var file = e.File; // IBrowserFile 타입

        var content = new MultipartFormDataContent();
        content.Add(new StreamContent(file.OpenReadStream(20_000_000)), "file", file.Name);

        var result = await Http.PostAsync("api/wiki/upload", content);
        if (!result.IsSuccessStatusCode)
        {
            // 실패 처리
            Console.WriteLine("이미지 업로드 실패");
            return;
        }

        var json = await result.Content.ReadFromJsonAsync<UploadResult>();
        
        await JS.InvokeVoidAsync("appendToTextarea", "editor", $"\n![]({json?.url})\n");
        Value += $"\n![]({json?.url})\n";
        await ValueChanged.InvokeAsync(Value);
    }

    public class UploadResult
    {
        public string url { get; set; }
    }

    /* =============== Markdown → HTML 변환기 =============== */
    private string MarkdownToHtml(string markdown)
    {
        if (string.IsNullOrEmpty(markdown))
            return "";

        string html = markdown
            .Replace("&", "&amp;")
            .Replace("<", "&lt;")
            .Replace(">", "&gt;");

        // 코드 블럭 ``` ```
        html = Regex.Replace(
            html,
            @"```([\s\S]+?)```",
            "<pre style='background-color:#e9ecef;padding:5px;'>$1</pre>");

        // 헤더 # ~ ######
        for (int i = 6; i >= 1; i--)
        {
            string pattern = @"^" + new string('#', i) + @"\s+(.+)$";
            string replacement = $"<h{i}>$1</h{i}>";
            html = Regex.Replace(
                html, pattern, replacement, RegexOptions.Multiline);
        }

        // 굵게 **text**
        html = Regex.Replace(
            html, @"\*\*(.+?)\*\*", "<b>$1</b>");

        // 기울임 *text*
        html = Regex.Replace(
            html, @"\*(.+?)\*", "<i>$1</i>");

        // 취소선 ~~text~~
        html = Regex.Replace(
            html, @"~~(.+?)~~", "<s>$1</s>");

        // 순서 없는 리스트 - 또는 *
        // 1) Markdown 리스트를 <li>로 변환
        html = Regex.Replace(html,
            @"^\s*[-*]\s+(.+)$",
            "<li>$1</li>",
            RegexOptions.Multiline);

        // 2) 연속된 <li> 묶음을 <ul>...</ul> 로 감싸기
        html = Regex.Replace(html,
            @"(?:<li>.*?</li>\s*)+",
            m => "<ul>\n" + m.Value + "\n</ul>",
            RegexOptions.Singleline);

        // 이미지 ![](url)
        html = Regex.Replace(
            html,
            @"!\[(.*?)\]\((.*?)\)",
            "<img src='$2' alt='$1' style='max-width:100%; margin:5px 0;' />");

        // 링크 [텍스트](url)
        html = Regex.Replace(
            html,
            @"\[(.+?)\]\((https?://.+?)\)",
            "<a href='$2' target='_blank'>$1</a>");

        // 줄바꿈
        html = html.Replace("\n", "<br>");

        return html;
    }
}
